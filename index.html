<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Art Nightstand Slideshow</title>
  <style>
    :root{
      --bg:#0b0b0f;           /* deep night */
      --fg:#e9e9ef;           /* text */
      --muted:#9aa0a6;        /* secondary text */
      --accent:#6ee7ff;       /* auto-tint from artwork */
      --surface:#121218;      /* cards */
      --btn:#1e1e27;
      --good:#2bd576;
      --bad:#ff6b6b;
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --radius:18px;
      --step-fade: 450ms;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{ margin:0; background:var(--bg); color:var(--fg); font:16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif; display:flex; min-height:100vh; }

    /* Stage centers a 16:9 frame but adapts to portrait/landscape elegantly */
    .stage{ position:relative; display:grid; place-items:center; width:100%; height:100vh; padding:1rem; }
    .frame{ position:relative; width:100%; height:100%; max-width:1600px; aspect-ratio:16/9; border-radius:var(--radius); overflow:hidden; background: radial-gradient(1200px 600px at 50% 110%, rgba(255,255,255,.05), transparent 60%); box-shadow: var(--shadow); display:grid; }

    /* Layout switches by orientation */
    .layout-portrait{ grid-template-rows: 1fr; }
    .layout-landscape{ grid-template-columns: 34% 66%; }

    /* Right panel = artwork in landscape; full frame in portrait */
    .art{ position:relative; width:100%; height:100%; display:grid; place-items:center; }
    .art img{ max-width:100%; max-height:100%; object-fit:contain; filter: drop-shadow(0 20px 40px rgba(0,0,0,.35)); }
    .tint{ position:absolute; inset:-12%; background:radial-gradient(60% 50% at 50% 65%, color-mix(in srgb, var(--accent) 22%, transparent), transparent 70%); filter: blur(60px); opacity:.6; pointer-events:none }

    /* Left column (landscape): big clock with meta below */
    .side{ display:flex; flex-direction:column; justify-content:flex-start; padding:1.2rem; gap:1rem; background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,0) 40%); }
    .clockWrap{ display:flex; flex-direction:column; align-items:flex-start; gap:.2rem; }
    .clock{ font-variant-numeric:tabular-nums; font-weight:800; line-height:1; letter-spacing:.5px; color:var(--accent); text-shadow:0 0 24px color-mix(in srgb, var(--accent) 40%, transparent); }
    .clock .ampm{ font-weight:600; color: color-mix(in srgb, var(--accent) 75%, white 10%); opacity:.9; margin-left:.25em; }

    .meta{ display:flex; flex-direction:column; gap:.35rem; max-width: 95%; }
    .kicker{ color:var(--accent); text-transform:uppercase; letter-spacing:.18em; font-weight:700; font-size:1rem; opacity:0; transform: translateY(8px); }
    .title{ font-size: clamp(1.3rem, 3.8vw, 2.4rem); font-weight:800; letter-spacing:.2px; line-height:1.1; opacity:0; transform: translateY(8px); }
    .sub{ color:var(--muted); font-size: clamp(1rem, 2.2vw, 1.1rem); opacity:0; transform: translateY(8px); }

    .reveal{ animation: fadeUp var(--step-fade) ease forwards; }
    .reveal:nth-child(1){ animation-delay:0ms }
    .reveal:nth-child(2){ animation-delay:80ms }
    .reveal:nth-child(3){ animation-delay:120ms }
    @keyframes fadeUp { to {opacity:1; transform: translateY(0)} }

    /* Portrait overlay: big clock top, meta bottom */
    .overlayTop{ position:absolute; top:.6rem; left:0; right:0; display:flex; justify-content:center; pointer-events:none; }
    .overlayClock{ font-variant-numeric:tabular-nums; font-weight:900; font-size: clamp(2.2rem, 10vw, 4rem); color:var(--accent); text-shadow:0 0 24px color-mix(in srgb, var(--accent) 40%, transparent); }
    .overlayBottom{ position:absolute; left:0; right:0; bottom:0; padding:1rem; background:linear-gradient( to top, rgba(3,3,5,.55), rgba(0,0,0,0) 40% ); }

    /* Hit areas for tap-to-navigate (left/back, right/forward) */
    .hits{ position:absolute; inset:0; display:grid; grid-template-columns:1fr 1fr; }
    .hit{ cursor:pointer; }

    /* Grading footer */
    .footer{ position:absolute; left:0; right:0; bottom:0; display:flex; justify-content:space-between; align-items:center; gap:.6rem; padding:.8rem 1rem; pointer-events:auto; }
    .btn{ background:var(--btn); color:var(--fg); border:1px solid rgba(255,255,255,.08); padding:.8rem 1.1rem; border-radius:14px; cursor:pointer; user-select:none; transition: transform .06s ease, background .2s ease, border-color .2s ease; }
    .btn:hover{ transform: translateY(-1px); }
    .btn.good{ border-color: color-mix(in srgb, var(--good) 55%, transparent); box-shadow: 0 0 0 1px color-mix(in srgb, var(--good) 30%, transparent) inset; }
    .btn.bad{ border-color: color-mix(in srgb, var(--bad) 55%, transparent); box-shadow: 0 0 0 1px color-mix(in srgb, var(--bad) 30%, transparent) inset; }
    .btn.selected{ outline:2px solid currentColor; filter: drop-shadow(0 0 12px currentColor); }

    /* Feedback check/cross */
    .mark{ position:absolute; bottom:4.8rem; right:1rem; font-size:2rem; opacity:0; transform:scale(.9); transition:opacity .25s ease, transform .25s ease; }
    .mark.show{ opacity:1; transform:scale(1); }

    /* Stats chip (optional) */
    .chip{ position:absolute; top:.6rem; right:.6rem; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.08); border-radius:999px; padding:.25rem .6rem; color:var(--muted); font-size:.9rem; }

    /* Responsive sizes */
    @media (orientation: landscape){
      .clock{ font-size: clamp(2.6rem, 7vw, 5.2rem); }
    }
    @media (orientation: portrait){
      .clock{ font-size: clamp(2.2rem, 10vw, 4.2rem); }
    }
  </style>
</head>
<body>
  <main class="stage">
    <section class="frame layout-portrait" id="frame">
      <!-- Landscape side panel (auto-hidden in portrait) -->
      <aside class="side" id="side" aria-hidden="true" hidden>
        <div class="clockWrap">
          <div class="clock" id="clock">--:--<span class="ampm" id="ampm"></span></div>
        </div>
        <div class="meta">
          <div id="artist" class="kicker" aria-hidden="true"></div>
          <div id="title" class="title" aria-hidden="true"></div>
          <div id="details" class="sub" aria-hidden="true"></div>
        </div>
      </aside>

      <!-- Artwork area -->
      <div class="art">
        <div class="tint" id="tint"></div>
        <img id="artImg" alt="Artwork" />
        <!-- Portrait overlays -->
        <div class="overlayTop"><div class="overlayClock" id="pClock" aria-hidden="true">--:--</div></div>
        <div class="overlayBottom" id="pMeta" aria-hidden="true">
          <div class="meta">
            <div id="pArtist" class="kicker" aria-hidden="true"></div>
            <div id="pTitle" class="title" aria-hidden="true"></div>
            <div id="pDetails" class="sub" aria-hidden="true"></div>
          </div>
        </div>
        
        <!-- Tap hit areas -->
        <div class="hits" id="hits">
          <div class="hit" id="hitLeft" aria-label="Back"></div>
          <div class="hit" id="hitRight" aria-label="Forward"></div>
        </div>

        <!-- Grading footer -->
        <div class="footer">
          <button id="btnBad" class="btn bad">Not yet</button>
          <span class="chip" id="chip">—</span>
          <button id="btnGood" class="btn good">Got it</button>
          <div class="mark" id="mark">✓</div>
        </div>
      </div>
    </section>
  </main>

  <script>
    /* ===== Config & State ===== */
    const CONFIG_KEY = 'artSRS_config_v2';
    const STATE_KEY  = 'artSRS_state_v2';
    const DEFAULTS = { tImage:4, tArtist:3, tTitle:3, tDetails:4, imageBase:'./art/', autoAccent:'on', easeDefault:2.5 };

    const el = {
      frame: document.getElementById('frame'),
      side: document.getElementById('side'),
      img: document.getElementById('artImg'),
      tint: document.getElementById('tint'),
      clock: document.getElementById('clock'), ampm: document.getElementById('ampm'),
      pClock: document.getElementById('pClock'),
      artist: document.getElementById('artist'), title: document.getElementById('title'), details: document.getElementById('details'),
      pArtist: document.getElementById('pArtist'), pTitle: document.getElementById('pTitle'), pDetails: document.getElementById('pDetails'), pMeta: document.getElementById('pMeta'),
      hitL: document.getElementById('hitLeft'), hitR: document.getElementById('hitRight'),
      btnGood: document.getElementById('btnGood'), btnBad: document.getElementById('btnBad'),
      mark: document.getElementById('mark'), chip: document.getElementById('chip')
    };

    let cfg = loadConfig();
    let deck = [];
    let progress = loadState(); // id -> progress
    let session = { index:0, phase:0, timers:[], today: dayISO(new Date()) };

    function loadConfig(){ const raw=localStorage.getItem(CONFIG_KEY); return raw?{...DEFAULTS, ...JSON.parse(raw)}:{...DEFAULTS}; }
    function saveConfig(){ localStorage.setItem(CONFIG_KEY, JSON.stringify(cfg)); }
    function loadState(){ const raw=localStorage.getItem(STATE_KEY); return raw?JSON.parse(raw):{}; }
    function saveState(){ localStorage.setItem(STATE_KEY, JSON.stringify(progress)); }

    function dayISO(d){ const z= new Date(d.getFullYear(), d.getMonth(), d.getDate()); return z.toISOString().slice(0,10); }
    function isHttp(url){ return /^https?:/i.test(url); }
    function clearTimers(){ session.timers.forEach(t=>clearTimeout(t)); session.timers=[]; }
    function restartTimer(ms, fn){ clearTimers(); const t=setTimeout(fn, ms); session.timers=[t]; }

    /* ===== Deck & Progress ===== */
    function ensureProgress(card){ if(!progress[card.id]) progress[card.id]={ ease: cfg.easeDefault, intervalDays:0, dueISO: session.today, reps:0, lapses:0, state:'new', learningStep:0, lastGrade:null }; return progress[card.id]; }

    function grade(card, kind){ const p=ensureProgress(card); const today=session.today; if(kind==='good'){ if(p.state==='new'){ p.state='learning'; p.learningStep=1; p.intervalDays=1; p.dueISO=dayISO(new Date(Date.now()+86400000)); } else if(p.state==='learning'){ if(p.learningStep===1){ p.learningStep=2; p.intervalDays=3; p.dueISO=dayISO(new Date(Date.now()+3*86400000)); } else { p.state='review'; p.learningStep=0; p.intervalDays=Math.max(5, p.intervalDays||5); p.dueISO=dayISO(new Date(Date.now()+p.intervalDays*86400000)); } } else { const next=Math.round(Math.max(1, p.intervalDays * p.ease)); p.intervalDays=next; p.dueISO=dayISO(new Date(Date.now()+next*86400000)); } p.reps++; }
      else { p.lapses++; p.state='learning'; p.learningStep=1; p.intervalDays=1; p.dueISO=dayISO(new Date(Date.now()+86400000)); }
      p.lastGrade = kind; saveState(); showGradeFeedback(kind); updateChip(); }

    /* ===== Orientation-aware layout ===== */
    function applyLayout(){ const portrait = window.matchMedia('(orientation: portrait)').matches; if(portrait){ el.frame.classList.remove('layout-landscape'); el.frame.classList.add('layout-portrait'); el.side.hidden=true; el.side.setAttribute('aria-hidden','true'); el.pClock.removeAttribute('aria-hidden'); el.pMeta.removeAttribute('aria-hidden'); } else { el.frame.classList.remove('layout-portrait'); el.frame.classList.add('layout-landscape'); el.side.hidden=false; el.side.removeAttribute('aria-hidden'); el.pClock.setAttribute('aria-hidden','true'); el.pMeta.setAttribute('aria-hidden','true'); } }

    /* ===== Accent from image ===== */
    function autoAccentFromImage(img){ try{ const canvas=document.createElement('canvas'); const ctx=canvas.getContext('2d',{willReadFrequently:true}); const w=canvas.width=80, h=canvas.height=80; ctx.drawImage(img,0,0,w,h); const data=ctx.getImageData(0,0,w,h).data; let r=0,g=0,b=0,c=0; for(let i=0;i<data.length;i+=4){ const a=data[i+3]; if(a<30) continue; r+=data[i]; g+=data[i+1]; b+=data[i+2]; c++; } if(c){ r=Math.round(r/c); g=Math.round(g/c); b=Math.round(b/c); const accent=`rgb(${r},${g},${b})`; document.documentElement.style.setProperty('--accent', accent); } }catch(e){} }

    /* ===== Clock (12-hour) ===== */
    function fmtTime(d){ let h=d.getHours(); const m=d.getMinutes().toString().padStart(2,'0'); const ampm = h>=12? 'PM':'AM'; h = h%12 || 12; return {h, m, ampm}; }
    function startClock(){ const tick=()=>{ const d=new Date(); const {h,m,ampm}=fmtTime(d); el.clock.textContent = `${h}:${m}`; el.ampm.textContent=ampm; el.pClock.textContent = `${h}:${m} ${ampm}`; }; tick(); setInterval(tick, 15000); }

    /* ===== Rendering ===== */
    function setMeta(artist, title, details){
      // Landscape meta
      el.artist.textContent=artist||''; el.title.textContent=title||''; el.details.textContent=details||'';
      // Portrait meta
      el.pArtist.textContent=artist||''; el.pTitle.textContent=title||''; el.pDetails.textContent=details||'';
    }
    function hideMeta(){ for(const n of [el.artist, el.title, el.details, el.pArtist, el.pTitle, el.pDetails]){ n.classList.remove('reveal'); n.style.opacity=0; n.style.transform='translateY(8px)'; } }

    async function loadImageFor(card){ return new Promise((resolve,reject)=>{ const src = isHttp(card.image)? card.image : (cfg.imageBase||'./') + card.image; el.img.onload=()=>resolve(); el.img.onerror=()=>resolve(); el.img.src=src; }); }

    function updateChip(){ const n=deck.length; const i=session.index+1; el.chip.textContent=`${i}/${n}`; }

    async function showCurrent(){ const card=deck[session.index]; if(!card) return; hideMeta(); setMeta('', '', ''); await loadImageFor(card); if(cfg.autoAccent==='on') autoAccentFromImage(el.img); session.phase=0; runReveal(); updateChip(); }

    function revealStep(){ const card=deck[session.index]; const artist=card.artist||''; const title=card.title||''; const details=[card.date, card.style].filter(Boolean).join(' • ');
      if(session.phase===0){ /* image only */ }
      else if(session.phase===1){ for(const n of [el.artist, el.pArtist]){ n.classList.add('reveal'); n.removeAttribute('aria-hidden'); n.textContent=artist; } }
      else if(session.phase===2){ for(const n of [el.title, el.pTitle]){ n.classList.add('reveal'); n.removeAttribute('aria-hidden'); n.textContent=title; } }
      else if(session.phase===3){ for(const n of [el.details, el.pDetails]){ n.classList.add('reveal'); n.removeAttribute('aria-hidden'); n.textContent=details; } }
    }

    function runReveal(){ const plan=[cfg.tImage, cfg.tArtist, cfg.tTitle, cfg.tDetails].map(Number);
      function scheduleNext(){ if(session.phase<3){ restartTimer(plan[session.phase]*1000, ()=>{ session.phase++; revealStep(); scheduleNext(); }); } else { // end of details -> advance to next artwork after details interval
          restartTimer(plan[3]*1000, ()=>{ nextCard(); }); }
      }
      // Start at image-only then schedule artist
      session.phase=0; revealStep(); scheduleNext();
    }

    function nextCard(){ session.index = (session.index+1)%deck.length; showCurrent(); }
    function prevCard(){ session.index = (session.index-1+deck.length)%deck.length; showCurrent(); session.phase=3; }

    function forward(){ if(session.phase<3){ session.phase++; revealStep(); restartTimer([cfg.tArtist,cfg.tTitle,cfg.tDetails][session.phase-1]*1000, ()=>{ if(session.phase<3){ session.phase++; revealStep(); } else { nextCard(); } }); } else { nextCard(); } }
    function backward(){ if(session.phase>0){ session.phase--; hideStepVisualBeyond(session.phase); restartTimer([cfg.tImage,cfg.tArtist,cfg.tTitle][session.phase]*1000, ()=>{ /* resume auto */ forward(); }); } else { prevCard(); } }

    function hideStepVisualBeyond(phase){ const map=[ [el.artist, el.pArtist], [el.title, el.pTitle], [el.details, el.pDetails] ]; for(let i=phase;i<3;i++){ for(const n of (map[i]||[])){ n.style.opacity=0; n.style.transform='translateY(8px)'; n.classList.remove('reveal'); } } }

    function showGradeFeedback(kind){ el.mark.textContent = kind==='good' ? '✓' : '✕'; el.mark.style.color = kind==='good' ? 'var(--good)' : 'var(--bad)'; el.mark.classList.add('show'); setTimeout(()=>el.mark.classList.remove('show'), 900); if(kind==='good'){ el.btnGood.classList.add('selected'); setTimeout(()=>el.btnGood.classList.remove('selected'), 800); } else { el.btnBad.classList.add('selected'); setTimeout(()=>el.btnBad.classList.remove('selected'), 800); } }

    /* ===== Events ===== */
    function onHit(e){ const rect = e.currentTarget.getBoundingClientRect(); const x = (e.touches? e.touches[0].clientX : e.clientX) - rect.left; if(x < rect.width/2){ backward(); } else { forward(); } }

    window.addEventListener('resize', applyLayout);
    document.getElementById('hits').addEventListener('click', onHit);
    document.getElementById('hits').addEventListener('touchstart', onHit, {passive:true});
    el.btnGood.addEventListener('click', ()=>{ grade(deck[session.index], 'good'); });
    el.btnBad.addEventListener('click', ()=>{ grade(deck[session.index], 'bad'); });

    // keyboard (optional)
    window.addEventListener('keydown', (e)=>{ if(e.key==='ArrowRight'){ forward(); } else if(e.key==='ArrowLeft'){ backward(); } else if(e.key.toLowerCase()==='g'){ grade(deck[session.index],'good'); } else if(e.key.toLowerCase()==='b'){ grade(deck[session.index],'bad'); } });

    /* ===== Init ===== */
    async function init(){ applyLayout(); startClock(); try{ const res= await fetch('deck.json'); deck = await res.json(); } catch(e){ deck = []; }
      if(!deck.length){ // fallback sample
        deck=[{id:'1', image:'https://upload.wikimedia.org/wikipedia/commons/3/3a/Vincent_Willem_van_Gogh_128.jpg', artist:'Vincent van Gogh', title:'Self-Portrait', date:'1887', style:'Post-Impressionism'}];
      }
      showCurrent();
    }
    init();
  </script>
</body>
</html>
